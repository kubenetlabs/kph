apiVersion: policyhub.io/v1alpha1
kind: PolicyHubConfig
metadata:
  name: default
  namespace: {{ .Values.namespace }}
  labels:
    app.kubernetes.io/name: kph-agent
    app.kubernetes.io/instance: {{ .Release.Name }}
    app.kubernetes.io/managed-by: {{ .Release.Service }}
spec:
  saasEndpoint: {{ .Values.agent.serverUrl | quote }}
  {{- if .Values.agent.clusterId }}
  # Legacy mode: Use pre-registered cluster from SaaS
  clusterIdSecretRef:
    name: kph-agent-config
    key: cluster-id
  apiTokenSecretRef:
    name: {{ .Values.agent.existingSecret | default "kph-agent-token" }}
    key: api-token
  {{- else }}
  # Bootstrap mode: Self-register with SaaS using registration token
  clusterName: {{ required "agent.clusterName is required when agent.clusterId is not set" .Values.agent.clusterName | quote }}
  registrationTokenSecretRef:
    name: {{ .Values.agent.existingSecret | default "kph-agent-token" }}
    key: api-token
  {{- end }}
  syncInterval: {{ printf "%ds" (int .Values.agent.syncInterval) | quote }}
  heartbeatInterval: {{ printf "%ds" (int .Values.agent.heartbeatInterval) | quote }}
  {{- if .Values.cluster.provider }}
  provider: {{ .Values.cluster.provider | quote }}
  {{- end }}
  {{- if .Values.cluster.region }}
  region: {{ .Values.cluster.region | quote }}
  {{- end }}
  {{- if .Values.cluster.environment }}
  environment: {{ .Values.cluster.environment | quote }}
  {{- end }}
  {{- if .Values.telemetry.hubble.enabled }}
  flowCollection:
    enabled: true
    hubbleAddress: {{ .Values.telemetry.hubble.address | quote }}
  {{- end }}
