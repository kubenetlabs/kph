{{/*
Database secret for embedded PostgreSQL
*/}}
{{- if and .Values.database.embedded.enabled (not .Values.database.embedded.auth.existingSecret) }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "kph.fullname" . }}-db
  labels:
    {{- include "kph.labels" . | nindent 4 }}
type: Opaque
data:
  {{- if .Values.database.embedded.auth.password }}
  postgres-password: {{ .Values.database.embedded.auth.password | b64enc }}
  {{- else }}
  postgres-password: {{ randAlphaNum 24 | b64enc }}
  {{- end }}
---
{{- end }}

{{/*
Auth secret for Clerk
*/}}
{{- if and (eq .Values.auth.provider "clerk") (not .Values.auth.clerk.existingSecret) }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "kph.fullname" . }}-auth
  labels:
    {{- include "kph.labels" . | nindent 4 }}
type: Opaque
stringData:
  publishable-key: {{ .Values.auth.clerk.publishableKey | quote }}
  secret-key: {{ .Values.auth.clerk.secretKey | quote }}
---
{{- end }}

{{/*
Auth secret for OIDC
*/}}
{{- if and (eq .Values.auth.provider "oidc") (not .Values.auth.oidc.existingSecret) }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "kph.fullname" . }}-auth
  labels:
    {{- include "kph.labels" . | nindent 4 }}
type: Opaque
stringData:
  client-secret: {{ .Values.auth.oidc.clientSecret | quote }}
---
{{- end }}

{{/*
LLM secret
*/}}
{{- if and .Values.llm.enabled .Values.llm.apiKey (not .Values.llm.existingSecret) }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "kph.fullname" . }}-llm
  labels:
    {{- include "kph.labels" . | nindent 4 }}
type: Opaque
stringData:
  api-key: {{ .Values.llm.apiKey | quote }}
---
{{- end }}

{{/*
Email secret for Resend
*/}}
{{- if and (eq .Values.email.provider "resend") .Values.email.resend.apiKey (not .Values.email.resend.existingSecret) }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "kph.fullname" . }}-email
  labels:
    {{- include "kph.labels" . | nindent 4 }}
type: Opaque
stringData:
  api-key: {{ .Values.email.resend.apiKey | quote }}
---
{{- end }}

{{/*
Security secret for encryption key
*/}}
{{- if not .Values.security.existingSecret }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "kph.fullname" . }}-security
  labels:
    {{- include "kph.labels" . | nindent 4 }}
type: Opaque
stringData:
  {{- if .Values.security.encryptionKey }}
  encryption-key: {{ .Values.security.encryptionKey | quote }}
  {{- else }}
  encryption-key: {{ randAlphaNum 32 | quote }}
  {{- end }}
{{- end }}
