{{- if .Values.app.enabled }}
apiVersion: v1
kind: Pod
metadata:
  name: "{{ include "kph.fullname" . }}-test"
  labels:
    {{- include "kph.labels" . | nindent 4 }}
  annotations:
    "helm.sh/hook": test
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
spec:
  containers:
    - name: test
      image: curlimages/curl:latest
      command:
        - sh
        - -c
        - |
          set -e
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "KPH Helm Test: Health Check Validation"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

          SERVICE="{{ include "kph.fullname" . }}:{{ .Values.app.service.port }}"
          HEALTH_URL="http://$SERVICE/api/health"

          echo "→ Testing health endpoint: $HEALTH_URL"

          # Fetch health status
          RESPONSE=$(curl -sf "$HEALTH_URL" || echo '{"status":"error"}')
          echo "→ Response: $RESPONSE"

          # Check if status is "ok"
          if echo "$RESPONSE" | grep -q '"status":"ok"'; then
            echo "✓ Health check passed"
          else
            echo "✗ Health check failed - status is not 'ok'"
            exit 1
          fi

          # Check database connectivity
          if echo "$RESPONSE" | grep -q '"connected":true'; then
            echo "✓ Database is connected"
          else
            echo "✗ Database connection failed"
            exit 1
          fi

          # Report configuration
          echo ""
          echo "Configuration detected:"
          echo "$RESPONSE" | grep -o '"auth":{[^}]*}' || echo "  Auth: (not detected)"
          echo "$RESPONSE" | grep -o '"llm":{[^}]*}' || echo "  LLM: (not detected)"
          echo "$RESPONSE" | grep -o '"email":{[^}]*}' || echo "  Email: (not detected)"

          echo ""
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "✓ All tests passed - KPH is healthy!"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
  restartPolicy: Never
{{- end }}
