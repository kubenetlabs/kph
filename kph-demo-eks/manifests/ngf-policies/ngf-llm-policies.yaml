# =============================================================================
# NGINX GATEWAY FABRIC SECURITY POLICIES
# Generated by Kubernetes Policy Hub (KPH)
# =============================================================================
#
# These policies provide L7 security for LLM ingress traffic using
# Gateway API resources compatible with NGF 1.4.0
#
# =============================================================================

---
# =============================================================================
# POLICY 1: Security Headers via HTTPRoute Filter
# =============================================================================
# Intent: "Add security headers to all responses to protect against
#          XSS, clickjacking, and other client-side attacks."
#
# Threat Mitigated: XSS, clickjacking, MIME sniffing
# =============================================================================
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: openwebui-route-secured
  namespace: llm-frontend
  labels:
    app.kubernetes.io/managed-by: kph
    kph.io/policy-type: security-headers
spec:
  parentRefs:
    - name: llm-gateway
      namespace: nginx-gateway
      sectionName: http
  hostnames:
    - "chat.llm.local"
    - "openwebui.llm.local"
  rules:
    - matches:
        - path:
            type: PathPrefix
            value: /
      filters:
        # Add security headers
        - type: ResponseHeaderModifier
          responseHeaderModifier:
            add:
              - name: X-Frame-Options
                value: "DENY"
              - name: X-Content-Type-Options
                value: "nosniff"
              - name: X-XSS-Protection
                value: "1; mode=block"
              - name: Referrer-Policy
                value: "strict-origin-when-cross-origin"
      backendRefs:
        - name: openwebui
          port: 8080
          weight: 100

---
# =============================================================================
# POLICY 2: Block Direct Ollama API Access
# =============================================================================
# Intent: "Block direct access to Ollama API endpoints from external clients.
#          Only OpenWebUI should communicate with Ollama."
#
# Threat Mitigated: API abuse, unauthorized LLM access, prompt injection
# Note: Returns 404 for blocked paths (no backend configured)
# =============================================================================
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: block-ollama-direct
  namespace: llm-frontend
  labels:
    app.kubernetes.io/managed-by: kph
    kph.io/policy-type: access-control
    kph.io/threat: api-abuse
spec:
  parentRefs:
    - name: llm-gateway
      namespace: nginx-gateway
      sectionName: http
  hostnames:
    - "chat.llm.local"
  rules:
    # Block /ollama/ prefix - no backend = 404
    - matches:
        - path:
            type: PathPrefix
            value: /ollama/api
      filters:
        - type: ResponseHeaderModifier
          responseHeaderModifier:
            set:
              - name: X-Blocked-By
                value: "KPH-Policy"
      # No backendRefs = request fails

---
# =============================================================================
# POLICY 3: Block Admin Endpoints
# =============================================================================
# Intent: "Block external access to admin endpoints"
#
# Threat Mitigated: Unauthorized admin access
# =============================================================================
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: block-admin-endpoints
  namespace: llm-frontend
  labels:
    app.kubernetes.io/managed-by: kph
    kph.io/policy-type: access-control
spec:
  parentRefs:
    - name: llm-gateway
      namespace: nginx-gateway
      sectionName: http
  hostnames:
    - "chat.llm.local"
  rules:
    - matches:
        - path:
            type: PathPrefix
            value: /admin
      filters:
        - type: ResponseHeaderModifier
          responseHeaderModifier:
            set:
              - name: X-Blocked-By
                value: "KPH-Policy"
      # No backendRefs = request fails

---
# =============================================================================
# Cilium Policy: NGF to OpenWebUI Communication
# =============================================================================
# Intent: "Allow NGINX Gateway Fabric to communicate with OpenWebUI.
#          This is the only ingress path into the LLM frontend."
#
# Integrates: Cilium + NGF for defense in depth
# =============================================================================
apiVersion: cilium.io/v2
kind: CiliumNetworkPolicy
metadata:
  name: allow-ngf-to-openwebui
  namespace: llm-frontend
  labels:
    app.kubernetes.io/managed-by: kph
    kph.io/policy-type: ingress-control
spec:
  description: "Allow traffic from NGINX Gateway Fabric to OpenWebUI"
  endpointSelector:
    matchLabels:
      app: openwebui
  ingress:
    # Allow from NGF pods
    - fromEndpoints:
        - matchLabels:
            app.kubernetes.io/name: nginx-gateway-fabric
      toPorts:
        - ports:
            - port: "8080"
              protocol: TCP
    # Allow health checks from kubelet
    - fromEntities:
        - host
      toPorts:
        - ports:
            - port: "8080"
              protocol: TCP

---
# =============================================================================
# Cilium Policy: Protect NGF from Unauthorized Access
# =============================================================================
# Intent: "Only allow external traffic to reach NGF on ports 80 and 443.
#          Block all other ingress to the gateway namespace."
#
# Threat Mitigated: Unauthorized gateway access, port scanning
# =============================================================================
apiVersion: cilium.io/v2
kind: CiliumNetworkPolicy
metadata:
  name: ngf-ingress-control
  namespace: nginx-gateway
  labels:
    app.kubernetes.io/managed-by: kph
    kph.io/policy-type: ingress-control
spec:
  description: "Control ingress to NGINX Gateway Fabric"
  endpointSelector:
    matchLabels:
      app.kubernetes.io/name: nginx-gateway-fabric
  ingress:
    # Allow external HTTP/HTTPS traffic
    - fromEntities:
        - world
        - cluster
      toPorts:
        - ports:
            - port: "80"
              protocol: TCP
            - port: "443"
              protocol: TCP
    # Allow health checks
    - fromEntities:
        - host
      toPorts:
        - ports:
            - port: "8080"
              protocol: TCP
  egress:
    # Allow to OpenWebUI only
    - toEndpoints:
        - matchLabels:
            app: openwebui
      toPorts:
        - ports:
            - port: "8080"
              protocol: TCP
    # Allow DNS
    - toEndpoints:
        - matchLabels:
            k8s:io.kubernetes.pod.namespace: kube-system
            k8s-app: kube-dns
      toPorts:
        - ports:
            - port: "53"
              protocol: UDP
