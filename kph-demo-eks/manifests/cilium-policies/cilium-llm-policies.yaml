# =============================================================================
# CILIUM NETWORK POLICIES FOR LLM SECURITY
# Generated by Kubernetes Policy Hub (KPH)
# =============================================================================
#
# These policies implement defense-in-depth for LLM workloads:
# 1. Strict egress control to prevent data exfiltration
# 2. L7-aware filtering for API endpoints
# 3. DNS-based allowlisting for external services
# 4. Micro-segmentation between LLM components
#
# =============================================================================

---
# =============================================================================
# POLICY 1: Ollama LLM Egress Lockdown
# =============================================================================
# Intent: "The Ollama LLM pod should only communicate with OpenWebUI.
#          Block ALL internet egress to prevent data exfiltration
#          via prompt injection attacks."
#
# Threat Mitigated: Prompt injection leading to data exfiltration
# CVE Reference: Generic LLM exfiltration attacks (OWASP LLM01, LLM02)
# =============================================================================
apiVersion: cilium.io/v2
kind: CiliumNetworkPolicy
metadata:
  name: ollama-egress-lockdown
  namespace: llm-system
  labels:
    app.kubernetes.io/managed-by: kph
    kph.io/policy-type: egress-control
    kph.io/threat: data-exfiltration
spec:
  description: "Restrict Ollama to only communicate with authorized internal services"
  endpointSelector:
    matchLabels:
      app: ollama
  ingress:
    # Allow from OpenWebUI only
    - fromEndpoints:
        - matchLabels:
            app: openwebui
            k8s:io.kubernetes.pod.namespace: llm-frontend
      toPorts:
        - ports:
            - port: "11434"
              protocol: TCP
    # Allow health checks
    - fromEntities:
        - host
      toPorts:
        - ports:
            - port: "11434"
              protocol: TCP
  egress:
    # Allow DNS resolution (cluster DNS only)
    - toEndpoints:
        - matchLabels:
            k8s:io.kubernetes.pod.namespace: kube-system
            k8s-app: kube-dns
      toPorts:
        - ports:
            - port: "53"
              protocol: UDP
            - port: "53"
              protocol: TCP
  # IMPLICIT DENY: All other egress is blocked
  # This prevents prompt injection attacks from exfiltrating data

---
# =============================================================================
# POLICY 2: OpenWebUI Egress Control (CVE-2025-64496 Mitigation)
# =============================================================================
# Intent: "OpenWebUI should only connect to internal Ollama. Block all
#          external connections to prevent SSE code injection attacks."
#
# Threat Mitigated: CVE-2025-64496 - SSE Code Injection via Direct Connections
# Severity: 8/10 (High)
# =============================================================================
apiVersion: cilium.io/v2
kind: CiliumNetworkPolicy
metadata:
  name: openwebui-egress-control
  namespace: llm-frontend
  labels:
    app.kubernetes.io/managed-by: kph
    kph.io/policy-type: egress-control
    kph.io/threat: rce-via-sse
    kph.io/cve: CVE-2025-64496
spec:
  description: "Restrict OpenWebUI to internal services only"
  endpointSelector:
    matchLabels:
      app: openwebui
  ingress:
    # Allow from NGF only
    - fromEndpoints:
        - matchLabels:
            app.kubernetes.io/name: nginx-gateway-fabric
      toPorts:
        - ports:
            - port: "8080"
              protocol: TCP
    # Allow health checks
    - fromEntities:
        - host
      toPorts:
        - ports:
            - port: "8080"
              protocol: TCP
  egress:
    # Allow DNS resolution
    - toEndpoints:
        - matchLabels:
            k8s:io.kubernetes.pod.namespace: kube-system
            k8s-app: kube-dns
      toPorts:
        - ports:
            - port: "53"
              protocol: UDP
            - port: "53"
              protocol: TCP
    # Allow internal Ollama connection
    - toEndpoints:
        - matchLabels:
            app: ollama
            k8s:io.kubernetes.pod.namespace: llm-system
      toPorts:
        - ports:
            - port: "11434"
              protocol: TCP

---
# =============================================================================
# POLICY 3: DNS Exfiltration Prevention
# =============================================================================
# Intent: "Prevent data exfiltration via DNS tunneling by restricting DNS
#          queries to cluster DNS only. Block external DNS servers."
#
# Threat Mitigated: DNS tunneling/exfiltration
# =============================================================================
apiVersion: cilium.io/v2
kind: CiliumNetworkPolicy
metadata:
  name: dns-exfiltration-prevention
  namespace: llm-system
  labels:
    app.kubernetes.io/managed-by: kph
    kph.io/policy-type: dns-security
    kph.io/threat: dns-exfiltration
spec:
  description: "Block DNS queries to external nameservers"
  endpointSelector: {}
  egress:
    # ONLY allow cluster DNS
    - toEndpoints:
        - matchLabels:
            k8s:io.kubernetes.pod.namespace: kube-system
            k8s-app: kube-dns
      toPorts:
        - ports:
            - port: "53"
              protocol: UDP
            - port: "53"
              protocol: TCP

---
# =============================================================================
# POLICY 4: Default Deny for LLM Frontend
# =============================================================================
# Intent: "Apply zero-trust default deny to frontend namespace."
#
# Best Practice: Zero Trust Network Architecture
# =============================================================================
apiVersion: cilium.io/v2
kind: CiliumNetworkPolicy
metadata:
  name: default-deny-llm-frontend
  namespace: llm-frontend
  labels:
    app.kubernetes.io/managed-by: kph
    kph.io/policy-type: default-deny
spec:
  description: "Default deny all traffic not explicitly allowed"
  endpointSelector: {}

---
# =============================================================================
# POLICY 5: Default Deny for LLM System
# =============================================================================
# Intent: "Apply zero-trust default deny to backend namespace."
#
# Best Practice: Zero Trust Network Architecture
# =============================================================================
apiVersion: cilium.io/v2
kind: CiliumNetworkPolicy
metadata:
  name: default-deny-llm-system
  namespace: llm-system
  labels:
    app.kubernetes.io/managed-by: kph
    kph.io/policy-type: default-deny
spec:
  description: "Default deny all traffic not explicitly allowed"
  endpointSelector: {}
