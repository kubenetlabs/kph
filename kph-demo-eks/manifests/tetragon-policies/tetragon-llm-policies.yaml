# =============================================================================
# TETRAGON TRACING POLICIES FOR LLM RUNTIME SECURITY
# Generated by Kubernetes Policy Hub (KPH)
# =============================================================================
#
# These policies provide runtime security for LLM workloads:
# 1. Shell execution prevention (RCE mitigation)
# 2. Suspicious process detection
# 3. Model file access auditing
# 4. Network tool blocking
#
# =============================================================================

---
# =============================================================================
# POLICY 1: Block Shell Execution in LLM Pods
# =============================================================================
# Intent: "If any shell process spawns inside the Ollama or OpenWebUI pods,
#          kill the process immediately and generate an alert."
#
# Threat Mitigated: Remote Code Execution via prompt injection or Functions API
# CVE Reference: CVE-2025-64496 (OpenWebUI RCE chain)
# =============================================================================
apiVersion: cilium.io/v1alpha1
kind: TracingPolicy
metadata:
  name: block-shell-in-llm-pods
  labels:
    app.kubernetes.io/managed-by: kph
    kph.io/policy-type: process-control
    kph.io/threat: rce
    kph.io/action: kill
spec:
  kprobes:
    - call: "sys_execve"
      syscall: true
      args:
        - index: 0
          type: "string"
      selectors:
        - matchNamespaces:
            - namespace: llm-system
              operator: In
            - namespace: llm-frontend
              operator: In
          matchBinaries:
            - operator: "In"
              values:
                - "/bin/sh"
                - "/bin/bash"
                - "/bin/dash"
                - "/bin/zsh"
                - "/usr/bin/sh"
                - "/usr/bin/bash"
                - "/usr/bin/zsh"
          matchActions:
            - action: Sigkill
            - action: NotifyEnforcer
              argError: -1

---
# =============================================================================
# POLICY 2: Block Network Tools in LLM Pods
# =============================================================================
# Intent: "Block execution of curl, wget, nc, and other network tools that
#          could be used for data exfiltration or reverse shells."
#
# Threat Mitigated: Data exfiltration, reverse shell establishment
# =============================================================================
apiVersion: cilium.io/v1alpha1
kind: TracingPolicy
metadata:
  name: block-network-tools-llm
  labels:
    app.kubernetes.io/managed-by: kph
    kph.io/policy-type: process-control
    kph.io/threat: exfiltration
    kph.io/action: kill
spec:
  kprobes:
    - call: "sys_execve"
      syscall: true
      args:
        - index: 0
          type: "string"
      selectors:
        - matchNamespaces:
            - namespace: llm-system
              operator: In
            - namespace: llm-frontend
              operator: In
          matchBinaries:
            - operator: "In"
              values:
                # Network download tools
                - "/usr/bin/curl"
                - "/usr/bin/wget"
                - "/bin/curl"
                - "/bin/wget"
                # Netcat variants (reverse shells)
                - "/usr/bin/nc"
                - "/usr/bin/netcat"
                - "/usr/bin/ncat"
                - "/bin/nc"
                - "/bin/netcat"
                # SSH/SCP (lateral movement)
                - "/usr/bin/ssh"
                - "/usr/bin/scp"
                - "/usr/bin/sftp"
                # Python (often used for exploit payloads)
                - "/usr/bin/python"
                - "/usr/bin/python3"
                - "/usr/local/bin/python"
                - "/usr/local/bin/python3"
          matchActions:
            - action: Sigkill
            - action: NotifyEnforcer
              argError: -1

---
# =============================================================================
# POLICY 3: Monitor Model File Access
# =============================================================================
# Intent: "Alert when any process accesses model files in /root/.ollama/models.
#          This helps detect model theft attempts."
#
# Threat Mitigated: Model exfiltration, intellectual property theft
# =============================================================================
apiVersion: cilium.io/v1alpha1
kind: TracingPolicy
metadata:
  name: monitor-model-file-access
  labels:
    app.kubernetes.io/managed-by: kph
    kph.io/policy-type: file-audit
    kph.io/threat: model-theft
    kph.io/action: audit
spec:
  kprobes:
    - call: "fd_install"
      syscall: false
      args:
        - index: 0
          type: "int"
        - index: 1
          type: "file"
      selectors:
        - matchNamespaces:
            - namespace: llm-system
              operator: In
          matchArgs:
            - index: 1
              operator: "Prefix"
              values:
                - "/root/.ollama/models"
          matchActions:
            - action: NotifyEnforcer

---
# =============================================================================
# POLICY 4: Detect Privilege Escalation Attempts
# =============================================================================
# Intent: "Detect and block any attempts to change user/group IDs or 
#          capabilities that could indicate privilege escalation."
#
# Threat Mitigated: Container escape, privilege escalation
# =============================================================================
apiVersion: cilium.io/v1alpha1
kind: TracingPolicy
metadata:
  name: detect-privilege-escalation
  labels:
    app.kubernetes.io/managed-by: kph
    kph.io/policy-type: privilege-monitoring
    kph.io/threat: container-escape
    kph.io/action: alert
spec:
  kprobes:
    # Monitor setuid calls
    - call: "sys_setuid"
      syscall: true
      args:
        - index: 0
          type: "int"
      selectors:
        - matchNamespaces:
            - namespace: llm-system
              operator: In
            - namespace: llm-frontend
              operator: In
          matchActions:
            - action: NotifyEnforcer
    # Monitor setgid calls
    - call: "sys_setgid"
      syscall: true
      args:
        - index: 0
          type: "int"
      selectors:
        - matchNamespaces:
            - namespace: llm-system
              operator: In
            - namespace: llm-frontend
              operator: In
          matchActions:
            - action: NotifyEnforcer

---
# =============================================================================
# POLICY 5: Cryptominer Detection
# =============================================================================
# Intent: "Detect execution of known cryptomining binaries. Exposed LLM 
#          infrastructure is often hijacked for cryptomining."
#
# Threat Mitigated: Resource hijacking, cryptojacking
# =============================================================================
apiVersion: cilium.io/v1alpha1
kind: TracingPolicy
metadata:
  name: detect-cryptominers
  labels:
    app.kubernetes.io/managed-by: kph
    kph.io/policy-type: process-control
    kph.io/threat: cryptojacking
    kph.io/action: kill
spec:
  kprobes:
    - call: "sys_execve"
      syscall: true
      args:
        - index: 0
          type: "string"
      selectors:
        - matchNamespaces:
            - namespace: llm-system
              operator: In
            - namespace: llm-frontend
              operator: In
          matchBinaries:
            - operator: "In"
              values:
                - "xmrig"
                - "minerd"
                - "cpuminer"
                - "cgminer"
                - "bfgminer"
                - "ethminer"
                - "stratum"
          matchActions:
            - action: Sigkill
            - action: NotifyEnforcer
              argError: -1
